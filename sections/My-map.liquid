{%- render 'section-spacing-collapsing' -%}

{%- assign jsonUrl = section.settings.url_json -%}


<style>
  #shopify-section-{{ section.id }} {
  }
  #shopify-section-{{ section.id }} .map-div {
    position: relative;
    overflow: hidden;
  }
  #shopify-section-{{ section.id }} #sidebar {
    width: 308px;
    max-width: 100%;
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    transition: all 500ms ease-in-out;
    transform: translateX(-100%);
    background-color: #fafafa;
    box-shadow: inset 1px 1px 0 rgba(0,0,0,.1), inset 0 -1px 0 rgba(0,0,0,.07);
    padding: 12px 20px;
  }
  #shopify-section-{{ section.id }} #sidebar #sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
    overflow: auto;
    
  }
  #shopify-section-{{ section.id }} #sidebar #sidebar-content h2{
    font-family: VolteRounded,sans-serif;
    font-weight: 700;
    font-size: 24px;
    color: #004228;
  }
  #shopify-section-{{ section.id }} #sidebar #sidebar-quit{
    position: absolute;
    right: 20px;
    top: 20px;
    cursor: pointer;
  }
  #shopify-section-{{ section.id }} #sidebar #sidebar-content strong{
    color: #004228;
  }
  #shopify-section-{{ section.id }} #sidebar.active {
    transform: translateX(0);
  }
  #shopify-section-{{ section.id }}  #map-container {
    height: 500px; /* Ajusta la altura según tus necesidades */
  }
</style>

<div {% render 'section-properties' %}>
  <div class="map-div">
    <div id="map-container"></div>
    <div id="sidebar">
      <svg id="sidebar-quit" onclick="closeSidebar" fill="#000000" height="10px" width="10px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 460.775 460.775" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M285.08,230.397L456.218,59.27c6.076-6.077,6.076-15.911,0-21.986L423.511,4.565c-2.913-2.911-6.866-4.55-10.992-4.55 c-4.127,0-8.08,1.639-10.993,4.55l-171.138,171.14L59.25,4.565c-2.913-2.911-6.866-4.55-10.993-4.55 c-4.126,0-8.08,1.639-10.992,4.55L4.558,37.284c-6.077,6.075-6.077,15.909,0,21.986l171.138,171.128L4.575,401.505 c-6.074,6.077-6.074,15.911,0,21.986l32.709,32.719c2.911,2.911,6.865,4.55,10.992,4.55c4.127,0,8.08-1.639,10.994-4.55 l171.117-171.12l171.118,171.12c2.913,2.911,6.866,4.55,10.993,4.55c4.128,0,8.081-1.639,10.992-4.55l32.709-32.719 c6.074-6.075,6.074-15.909,0-21.986L285.08,230.397z"></path> </g></svg>
      <div id="sidebar-content">
          <!-- Los datos del marcador se mostrarán aquí -->
      </div>
    </div>
  </div>
</div>
{%- comment -%}On the FAQ page, we also output the content with JSON microdata for SEO{%- endcomment -%}
<script>
    // URL del archivo JSON
    var jsonUrl = "{{ jsonUrl | escape }}";
    var selectedMarker;
    initMap();
    // Inicializar el mapa
    function initMap() {
      // Crear un nuevo mapa de Google
  var center = { lat: -33.83155, lng: -70.706332 };
      var map = new google.maps.Map(document.getElementById('map-container'), {
        zoom: 10, // Ajusta el nivel de zoom según tus necesidades
        center: center, // Centrar el mapa en una ubicación inicial
      });

      // Obtener los datos del JSON y agregar marcadores al mapa
      fetch(jsonUrl)
        .then(response => response.json())
        .then(data => {
          var bounds = new google.maps.LatLngBounds();

          data.forEach(item => {
            // Verificar que el objeto tenga latitud y longitud
            if (item.lat && item.lng) {
              // Crear un marcador en el mapa
              var marker = new google.maps.Marker({
                  position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
                  map: map,
                  title: item.title || 'Marcador',
                  data: item, // Adjunta los datos del marcador al marcador mismo
                });
                marker.setIcon('https://cdn.shopify.com/s/files/1/0280/0854/6397/files/map-pin.png?v=1700192774');

             // Agrega un evento de clic al marcador
            marker.addListener('click', function () {
              if (selectedMarker) {
                // console.log('selectedMarker');
                // selectedMarker.setIcon(null); // Restaura el icono del marcador previamente seleccionado
              }
              selectedMarker = marker;
              closeSidebar(); // Cierra el sidebar si está abierto
              showMarkerData(marker.data); // Muestra los datos en el sidebar al hacer clic
              // marker.setIcon('https://maps.google.com/mapfiles/ms/icons/yellow-dot.png'); // Cambia el icono del marcador seleccionado
            });



              bounds.extend(marker.getPosition());
            }
          });
          console.log(bounds);
          map.fitBounds(bounds);
        })

        .catch(error => console.error('Error al cargar el JSON:', error));
         // Agregar evento de clic al mapa para cerrar el sidebar
        map.addListener('click', function () {
          closeSidebar();
        });
    }
    function showMarkerData(data) {
        var sidebar = document.getElementById('sidebar');
        var sidebarContent = document.getElementById('sidebar-content');
        sidebarContent.innerHTML = `
            <h2>${data["Nombre de cliente/proveedor"]}</h2>
            <p><strong>Región:</strong> ${data["(L) Región"]}</p>
            <p><strong>Comuna:</strong> ${data["Comuna"]}</p>
            <p><strong>Dirección:</strong> ${data["Dirección"]}</p>
            <p><strong>Descripción Local:</strong> ${data["(L) Descripción Local"]}</p>
        `;
        sidebar.classList.add('active')
    }
    
  function closeSidebar() {
    if (sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
    }
    if (selectedMarker) {
      // selectedMarker.setIcon(null); // Restaura el icono del marcador previamente seleccionado al cerrar el sidebar
      selectedMarker = null;
    }
  }
  </script>

{% schema %}
{
  "name": "My Map",
  "class": "shopify-section--my-map",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "text",
      "id": "url_json",
      "label": "URL Json"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading"
    }
  ],
  "presets": [
    {
      "name": "My Map"
    }
  ]
}
{% endschema %}