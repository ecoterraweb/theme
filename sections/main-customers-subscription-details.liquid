<style>
  ._cont_btn_save button {
    margin-top: 1rem;
    padding: 0.2rem 1rem;
    border-radius: 8px;
    font-weight: 800;
    color: rgb(255, 255, 255);
    background-color: rgb(2, 99, 56);
  }

  td._pre_name {
    white-space: pre;
  }
  
  td._cont_selects {
    padding-right: 4rem;
  }

  ._error {
    font-weight: normal;
    margin-left: 1rem;
  }

  .svg_loading {
    animation: rotating_svg 2s linear infinite;
  }

  @keyframes rotating_svg {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<div style="display: none;">

  <div id="obj_loading">
    <div class="empty-state">
      <div class="empty-state__icon-wrapper">
        {%- render 'icon' with 'loading'
          , width: 32
          , height: 32
          , stroke_width: 1 -%}
      </div>

      <div class="prose">
        <p class="h6">Cargando...</p>
      </div>
    </div>
  </div>

  <div id="obj_empty">
    <div class="empty-state">
      <div class="empty-state__icon-wrapper">
        {%- render 'icon' with 'subscriptions'
          , width: 32
          , height: 32
          , stroke_width: 1 -%}
        <span class="count-bubble count-bubble--lg">0</span>
      </div>

      <div class="prose">
        <p class="h6">Aún no has realizado ninguna suscripción.</p>

        {%- assign button_content = 'customer.account.continue_shopping' | t -%}
        {%- render 'button'
          , href: routes.all_products_collection_url
          , size: 'xl'
          , content: button_content -%}
      </div>
    </div>
  </div>

  <div id="obj_error">
    <div class="empty-state">
      <div class="empty-state__icon-wrapper">
        {%- render 'icon' with 'error'
          , width: 32
          , height: 32
          , stroke_width: 1 -%}
      </div>

      <div class="prose">
        <p class="h6">Ocurrio un error:
          <span class="_error"></span>
        </p>
      </div>
    </div>
  </div>

  <div id="obj_list">
    <div class="page-spacer">
      <div class="account">
        <div class="account-header account-header--back">
          <a href="/pages/mis-suscripciones" class="back-button justify-self-start">
            {%- render 'icon' with 'chevron-left' -%}
            {{- 'customer.order.back' | t -}}
          </a>

          <div class="v-stack gap-2">
            <h1 class="h3">Suscripción</h1>
            <p class="_param_fecha_suscripcion"></p>
          </div>
        </div>

        <div class="order">
          <div class="v-stack gap-6">
            <table class="order-summary">
              <thead class="order-summary__header">
                <tr>
                  <th>Productos</th>
                  <th class="text-end">Estado</th>
                </tr>
              </thead>

              <tbody class="order-summary__body"></tbody>

              <tfoot>
                <tr>
                  <td colspan="1" class="_cont_selects">
                    <div class="v-stack gap-2 text-start">
                      <div class="h-stack gap-4 justify-between">
                        <span>Frecuencia</span>
                        <select name="pr:frecuencia">
                          <option value="2">Semanal</option>
                          <option value="5">Quincenal</option>
                          <option value="3">Mensual</option>
                        </select>
                      </div>

                      <div class="h-stack gap-4 justify-between">
                        <span>Día de entrega</span>
                        <select name="pr:dia_entrega">
                          <option>Lunes</option>
                          <option>Martes</option>
                          <option>Miércoles</option>
                          <option>Jueves</option>
                          <option>Viernes</option>
                        </select>
                      </div>

                      <div class="h-stack gap-4 justify-between _cont_btn_save" style="display: none;">
                        <span></span>
                        <button type="button">Guardar</button>
                      </div>
                    </div>
                  </td>

                  <td colspan="2">
                    <div class="v-stack gap-2 text-start">
                      <div class="h-stack gap-4 justify-between">
                        <span>Subtotal</span>
                        <span class="pr:valor_subtotal">$38.980 CLP</span>
                      </div>

                      <div class="h-stack gap-4 justify-between">
                        <span>Descuento por suscripción</span>
                        <span class="pr:valor_descuento">-120</span>
                      </div>

                      <div class="h-stack gap-4 justify-between">
                        <span>Valor despacho</span>
                        <span class="pr:valor_despacho">100</span>
                      </div>

                      <div class="h-stack gap-4 justify-between">
                        <span class="h6">Total</span>
                        <span class="h6 pr:valor_total"></span>
                      </div>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>


          <div class="order-addresses-list">

            <div class="address gap-4 rounded-sm">
              <div class="text-with-icon">
                {%- render 'icon' with 'picto-box' -%}
                <p class="bold">{{ 'customer.order.shipping_address' | t }}</p>
              </div>
              {{- customer.default_address | format_address -}}
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="container" id="cont_subscriptons">
  <div class="empty-state">
    <div class="empty-state__icon-wrapper">
      {%- render 'icon' with 'loading'
        , width: 32
        , height: 32
        , stroke_width: 1 -%}
    </div>

    <div class="prose">
      <p class="h6">Cargando...</p>
    </div>
  </div>
</div>

<script>
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const _cont_subscriptons = document.getElementById("cont_subscriptons");
    const _obj_loading = document.getElementById("obj_loading");
    const _obj_empty = document.getElementById("obj_empty");
    const _obj_error = document.getElementById("obj_error");
    const _obj_list = document.getElementById("obj_list");
    let _element_frecuencia;
    let _element_dia_entrega;
    let _element_btn_save;
    let _current_frecuencia;
    let _current_dia_entrega;

    const format = (_num) => {
        return _num < 10 ? "0" + _num : _num;
    }

    const detalleSuscripcion = async (_id) => {
        const formData = new FormData();

        formData.append('accion', 'detalle_suscripcion');
        formData.append('suscripcion_id', _id);
        formData.append('customer_id', '{{customer.id}}');

        await fetch('https://sarguero.btsmensajeria.com/suscripciones', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log("respondio");
                console.log(data);

                if (data.response == 1) {
                    let _frecuencia = 0;
                    let item = data.suscripcion[0];
                    let _fecha_suscripcion = new Date(item.fecha_suscripcion.replace('Z', ''));
                    let _horas = _fecha_suscripcion.getHours();
                    let _periodo = "am";
                    if (_horas >= 12) {
                        _periodo = "pm";
                    }

                    switch (item.frecuencia) {
                        case 'semanal':
                            _frecuencia = '2';
                            break;
                        case 'quincenal':
                            _frecuencia = '5';
                            break;
                        case 'mensual':
                            _frecuencia = '3';
                            break;
                    }

                    _current_frecuencia = _frecuencia;
                    _current_dia_entrega = item.dia_entrega;

                    _cont_subscriptons.innerHTML = _obj_list.innerHTML;
                    _cont_subscriptons.getElementsByClassName("_param_fecha_suscripcion")[0].innerText = `${meses[_fecha_suscripcion.getMonth()]} ${format(_fecha_suscripcion.getDate())}, ${_fecha_suscripcion.getFullYear()}  ${format(_horas % 12)}:${format(_fecha_suscripcion.getMinutes())} ${_periodo}`;
                    _cont_subscriptons.getElementsByClassName("pr:valor_subtotal")[0].innerText = item.producto_precio;
                    _cont_subscriptons.getElementsByClassName("pr:valor_descuento")[0].innerText = item.producto_precio;
                    _cont_subscriptons.getElementsByClassName("pr:valor_despacho")[0].innerText = item.producto_precio;
                    _cont_subscriptons.getElementsByClassName("pr:valor_total")[0].innerText = item.producto_precio;
                    _cont_subscriptons.getElementsByTagName("tbody")[0].innerHTML = `<tr>
                                <td class="_pre_name">${item.producto_nombre}</td>
                                <td class="hidden align-center text-subdued text-end sm:table-cell">${item.estado}</td>
                            </tr>`;
                    _element_btn_save = _cont_subscriptons.getElementsByClassName("_cont_btn_save")[0];
                    _element_frecuencia = _cont_subscriptons.querySelector("select[name='pr:frecuencia']");
                    _element_dia_entrega = _cont_subscriptons.querySelector("select[name='pr:dia_entrega']");
                    _element_frecuencia.value = _frecuencia;
                    _element_dia_entrega.value = item.dia_entrega;

                    if (item.estado === "Pagada") {
                        _element_frecuencia.addEventListener('change', function () {
                            console.log(this.value);
                            if(_current_frecuencia === this.value &&
                            _current_dia_entrega === _element_dia_entrega.value ){
                                _element_btn_save.style.display = "none";
                            } else {
                                _element_btn_save.style.display = "flex";
                            }
                        });
                        _element_dia_entrega.addEventListener('change', function () {
                            console.log(this.value);
                            if(_current_dia_entrega === this.value &&
                            _current_frecuencia === _element_frecuencia.value){
                                _element_btn_save.style.display = "none";
                            } else {
                                _element_btn_save.style.display = "flex";
                            }
                        });
                    }
                } else {
                    _cont_subscriptons.innerHTML = _obj_empty.innerHTML;
                }
            })
            .catch((error) => {
                console.log("Ocurrio un error");
                console.log({ "response": -1, "msg": error.toString() });

                _obj_error.getElementsByClassName('_error')[0].innerText = `(${error.toString()})`;
                _cont_subscriptons.innerHTML = _obj_error.innerHTML;
            });
    }

    window.addEventListener('load', function () {
        let _url = window.location.href;
        let _id_base64 = _url.split("/").pop();
        let _id_suscripcion = atob(_id_base64);

        detalleSuscripcion(_id_suscripcion);
    });
</script>

{% schema %}
  {
    "name": "Subscriptions details",
    "class": "shopify-section--main-subscriptions-details",
    "tag": "section"
  }
{% endschema %}